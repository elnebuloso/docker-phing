<?xml version="1.0" encoding="UTF-8"?>


<project default="report:sonarqube">


    <target name="report:sonarqube:init" depends="commons:init">
        <property name="reportSonarqubeDescription" value="sonarqube scanner code analysis"/>
        <property name="reportSonarqubeExecutable" value="sonarqube-scanner"/>
        <property name="reportSonarqubeHostUrl" value=""/>
        <property name="reportSonarqubeLogin" value=""/>
        <property name="reportSonarqubeConfig" value="${project.root}/sonar-project.properties"/>
        <property name="reportSonarqubeProjectKey" value="${projectName}"/>
        <property name="reportSonarqubeProjectVersion" value="${projectVersion}"/>
    </target>


    <target name="report:sonarqube:help" depends="report:sonarqube:init">
        <echo message="${reportSonarqubeDescription}"/>

        <echo message=""/>
        <echo message="property                         value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="reportSonarqubeExecutable        ${reportSonarqubeExecutable}"/>
        <echo message="reportSonarqubeHostUrl           ${reportSonarqubeHostUrl}"/>
        <echo message="reportSonarqubeLogin             ${reportSonarqubeLogin}"/>
        <echo message="reportSonarqubeConfig            ${reportSonarqubeConfig}"/>
        <echo message="reportSonarqubeProjectKey        ${reportSonarqubeProjectKey}"/>
        <echo message="reportSonarqubeProjectVersion    ${reportSonarqubeProjectVersion}"/>
        <echo message="branchName                       - adhoc property"/>
        <echo message="buildNumber                      - adhoc property"/>
    </target>


    <target name="report:sonarqube" depends="report:sonarqube:init, report:sonarqube:before, report:sonarqube:main, report:sonarqube:after">
        <echo message="successful"/>
    </target>


    <target name="report:sonarqube:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="report:sonarqube:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="report:sonarqube:main">
        <mkdir dir="${projectDirBuildTmp}"/>

        <if>
            <and>
                <isset property="branchName"/>
                <not>
                    <equals arg1="${branchName}" arg2="master"/>
                </not>
            </and>
            <then>
                <property name="reportSonarqubeProjectVersion" value="${reportSonarqubeProjectVersion}-${branchName}"/>
                <if>
                    <isset property="buildNumber"/>
                    <then>
                        <property name="reportSonarqubeProjectVersion" value="${reportSonarqubeProjectVersion}-${buildNumber}"/>
                    </then>
                </if>
            </then>
        </if>

        <echo message="${reportSonarqubeProjectVersion}"/>
        <exec executable="${reportSonarqubeExecutable}" passthru="true" checkreturn="true" level="info" dir="${project.root}">
            <arg line="--define sonar.userHome=${projectDirBuildTmp}"/>
            <arg line="--define sonar.host.url=${reportSonarqubeHostUrl}"/>
            <arg line="--define sonar.login=${reportSonarqubeLogin}"/>
            <arg line="--define project.settings=${reportSonarqubeConfig}"/>
            <arg line="--define sonar.projectKey=${reportSonarqubeProjectKey}"/>
            <arg line="--define sonar.projectVersion=${reportSonarqubeProjectVersion}"/>
        </exec>
    </target>


</project>