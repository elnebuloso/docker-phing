<?xml version="1.0" encoding="UTF-8"?>


<project default="report:sonarqube">


    <property name="report_sonarqube_description" value="sonarqube scanner code analysis" override="true"/>


    <target name="report:sonarqube:init" hidden="true">
        <property name="report_sonarqube_executable" value="sonarqube-scanner"/>
        <property name="report_sonarqube_host_url" value=""/>
        <property name="report_sonarqube_login" value=""/>
        <property name="report_sonarqube_config" value="${project_root}/sonar-project.properties"/>
        <property name="report_sonarqube_project_key" value="${project_name}"/>
        <property name="report_sonarqube_project_version" value="${project_version}"/>
        <property name="branch_name_master" value="master"/>
    </target>


    <target name="report:sonarqube:help" depends="report:sonarqube:init">
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="${report_sonarqube_description}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="property                            value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="report_sonarqube_executable         ${report_sonarqube_executable}"/>
        <echo message="report_sonarqube_host_url           ${report_sonarqube_host_url}"/>
        <echo message="report_sonarqube_login              ${report_sonarqube_login}"/>
        <echo message="report_sonarqube_config             ${report_sonarqube_config}"/>
        <echo message="report_sonarqube_project_key        ${report_sonarqube_project_key}"/>
        <echo message="report_sonarqube_project_version    ${report_sonarqube_project_version}"/>
        <echo message="branch_name_master                  ${branch_name_master}"/>
        <echo message="branch_name                         ${branch_name}"/>
        <echo message="build_number                        ${build_number}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
    </target>


    <target name="report:sonarqube" depends="report:sonarqube:init, report:sonarqube:before, report:sonarqube:main, report:sonarqube:after">
        <echo message="successful"/>
    </target>


    <target name="report:sonarqube:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="report:sonarqube:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="report:sonarqube:main" hidden="true">
        <mkdir dir="${project_dir_build_tmp}"/>

        <if>
            <and>
                <isset property="branch_name"/>
                <not>
                    <equals arg1="${branch_name}" arg2="${branch_name_master}"/>
                </not>
            </and>
            <then>
                <property name="report_sonarqube_project_version" value="${report_sonarqube_project_version}-${branch_name}"/>
                <if>
                    <isset property="build_number"/>
                    <then>
                        <property name="report_sonarqube_project_version" value="${report_sonarqube_project_version}-${build_number}"/>
                    </then>
                </if>
            </then>
        </if>

        <echo message="${report_sonarqube_project_version}"/>

        <exec executable="${report_sonarqube_executable}" passthru="true" checkreturn="true" level="info" dir="${project_root}">
            <arg line="--define sonar.userHome=${project_dir_build_tmp}"/>
            <arg line="--define sonar.host.url=${report_sonarqube_host_url}"/>
            <arg line="--define sonar.login=${report_sonarqube_login}"/>
            <arg line="--define project.settings=${report_sonarqube_config}"/>
            <arg line="--define sonar.projectKey=${report_sonarqube_project_key}"/>
            <arg line="--define sonar.project_version=${report_sonarqube_project_version}"/>
        </exec>
    </target>


</project>
