<?xml version="1.0" encoding="UTF-8"?>


<project default="docker:push">


    <property name="dockerPushDescription" value="push project docker image to a registry" override="true"/>


    <target name="docker:push:init" depends="docker:init">
        <property name="dockerPushLatest" value="disabled"/>
        <property name="dockerPushSemver" value="disabled"/>
        <property name="dockerPushCleanup" value="enabled"/>
        <property name="dockerConfigPushLatest" value="${dockerPushLatest}"/>
        <property name="dockerConfigPushLatestReason" value=""/>
        <property name="dockerConfigPushSemver" value="${dockerPushSemver}"/>
        <property name="dockerConfigPushSemverReason" value=""/>

        <if>
            <and>
                <not>
                    <equals arg1="${branchName}" arg2=""/>
                </not>
                <not>
                    <equals arg1="${branchName}" arg2="${branchNameMaster}"/>
                </not>
            </and>
            <then>
                <property name="dockerConfigPushLatest" value="disabled" override="true"/>
                <property name="dockerConfigPushLatestReason" value="- branchName is given or branchName is not the same as specific branchNameMaster" override="true"/>
            </then>
        </if>

        <if>
            <equals arg1="${dockerConfigPushLatest}" arg2="disabled"/>
            <then>
                <property name="dockerConfigPushSemver" value="disabled" override="true"/>
                <property name="dockerConfigPushSemverReason" value="- push latest not allowed" override="true"/>
            </then>
        </if>
    </target>


    <target name="docker:push:help" depends="docker:push:init">
        <echo message="${dockerPushDescription}"/>

        <echo message=""/>
        <echo message="property                      value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="dockerPushLatest              ${dockerPushLatest}"/>
        <echo message="dockerPushSemver              ${dockerPushSemver}"/>
        <echo message="dockerPushCleanup             ${dockerPushCleanup}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="dockerConfigImageVersion      ${dockerConfigImageVersion}" level="warning"/>
        <echo message="dockerConfigImage             ${dockerConfigImage}" level="warning"/>
        <echo message="dockerConfigImageTag          ${dockerConfigImageTag}" level="warning"/>
        <echo message="dockerConfigImageTagLatest    ${dockerConfigImageTagLatest}" level="warning"/>
        <echo message="dockerConfigImageTagMajor     ${dockerConfigImageTagMajor}" level="warning"/>
        <echo message="dockerConfigImageTagMinor     ${dockerConfigImageTagMinor}" level="warning"/>
        <echo message="dockerConfigImageTagPatch     ${dockerConfigImageTagPatch}" level="warning"/>
        <echo message="dockerConfigPushLatest        ${dockerConfigPushLatest} ${dockerConfigPushLatestReason}" level="warning"/>
        <echo message="dockerConfigPushSemver        ${dockerConfigPushSemver} ${dockerConfigPushSemverReason}" level="warning"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="docker:help for main configuration"/>
    </target>


    <target name="docker:push" depends="docker:push:init, docker:push:before, docker:push:main, docker:push:after">
        <echo message="successful"/>
    </target>


    <target name="docker:push:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:main">
        <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
        <exec command="docker push ${dockerConfigImageTag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

        <if>
            <equals arg1="${dockerConfigPushLatest}" arg2="enabled"/>
            <then>
                <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <if>
                    <equals arg1="${dockerPushCleanup}" arg2="enabled"/>
                    <then>
                        <exec command="docker rmi ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <equals arg1="${dockerConfigPushSemver}" arg2="enabled"/>
            <then>
                <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTagMajor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${dockerConfigImageTagMajor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTagMinor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${dockerConfigImageTagMinor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTagPatch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${dockerConfigImageTagPatch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <if>
                    <equals arg1="${dockerPushCleanup}" arg2="enabled"/>
                    <then>
                        <exec command="docker rmi ${dockerConfigImageTagMajor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                        <exec command="docker rmi ${dockerConfigImageTagMinor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                        <exec command="docker rmi ${dockerConfigImageTagPatch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <equals arg1="${dockerPushCleanup}" arg2="enabled"/>
            <then>
                <exec command="docker rmi ${dockerConfigImageTag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker rmi ${dockerConfigImage}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
            </then>
        </if>
    </target>


</project>