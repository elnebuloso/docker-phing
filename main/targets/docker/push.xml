<?xml version="1.0" encoding="UTF-8"?>


<project default="docker:push">


    <property name="dockerPushDescription" value="push project docker image to a registry" override="true"/>


    <target name="docker:push:init" depends="docker:init">
        <property name="dockerPushLatest" value="enabled"/>
        <property name="dockerPushCleanup" value="enabled"/>
    </target>


    <target name="docker:push:help" depends="docker:push:init">
        <echo message="${dockerPushDescription}"/>

        <echo message=""/>
        <echo message="property                      value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="dockerPushLatest              ${dockerPushLatest}"/>
        <echo message="dockerPushCleanup             ${dockerPushCleanup}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="dockerConfigImageVersion      ${dockerConfigImageVersion}" level="warning"/>
        <echo message="dockerConfigImage             ${dockerConfigImage}" level="warning"/>
        <echo message="dockerConfigImageTag          ${dockerConfigImageTag}" level="warning"/>
        <echo message="dockerConfigImageTagLatest    ${dockerConfigImageTagLatest}" level="warning"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="docker:help for main configuration"/>
    </target>


    <target name="docker:push" depends="docker:push:init, docker:push:before, docker:push:main, docker:push:after">
        <echo message="successful"/>
    </target>


    <target name="docker:push:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:main">
        <echo message="${dockerConfigImage}"/>
        <echo message="${dockerConfigImageTag}"/>

        <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTag}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
        <exec command="docker push ${dockerImageTag}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>

        <if>
            <and>
                <equals arg1="${dockerPushLatest}" arg2="enabled"/>
                <or>
                    <equals arg1="${branchName}" arg2=""/>
                    <equals arg1="${branchName}" arg2="${branchNameMaster}"/>
                </or>
            </and>
            <then>
                <echo message=""/>
                <echo message="pushing latest image tag, push latest is allowed and branchName is empty or equals branchNameMaster"/>
                <echo message="${dockerConfigImage}"/>
                <echo message="${dockerConfigImageTagLatest}"/>

                <exec command="docker tag ${dockerConfigImage} ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
                <exec command="docker push ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
            </then>
        </if>

        <if>
            <equals arg1="${dockerPushCleanup}" arg2="enabled"/>
            <then>
                <exec command="docker rmi ${dockerConfigImageTag}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
                <exec command="docker rmi ${dockerConfigImageTagLatest}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
                <exec command="docker rmi ${dockerConfigImage}" passthru="true" checkreturn="true" level="info" dir="${project.root}"/>
            </then>
        </if>
    </target>


</project>