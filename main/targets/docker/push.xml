<?xml version="1.0" encoding="UTF-8"?>


<project default="docker:push">


    <target name="docker:push:init">
        <property name="dockerPushDescription" value="push project image to a registry"/>
        <property name="dockerImageName" value="${projectName}"/>
        <property name="dockerImageVersion" value="${projectVersion}"/>
        <property name="dockerImageNamespace" value=""/>
        <property name="dockerRegistry" value=""/>
    </target>


    <target name="docker:push:help" depends="docker:push:init">
        <echo message="${dockerPushDescription}"/>

        <echo message=""/>
        <echo message="property                value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="dockerImageName         ${dockerImageName}"/>
        <echo message="dockerImageVersion      ${dockerImageVersion}"/>
        <echo message="dockerImageNamespace    ${dockerImageNamespace}"/>
        <echo message="dockerRegistry          ${dockerRegistry}"/>
        <echo message="branchName              - adhoc property"/>
        <echo message="buildNumber             - adhoc property"/>
    </target>


    <target name="docker:push" depends="docker:push:init, docker:push:before, docker:push:main, docker:push:after">
        <echo message="successful"/>
    </target>


    <target name="docker:push:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:main">
        <fail message="dockerRegistry not defined">
            <condition>
                <equals arg1="${dockerRegistry}" arg2=""/>
            </condition>
        </fail>

        <if>
            <and>
                <isset property="branchName"/>
            </and>
            <then>
                <property name="dockerImageName" value="${dockerImageName}:${branchName}" override="true"/>
                <if>
                    <isset property="buildNumber"/>
                    <then>
                        <property name="dockerImageName" value="${dockerImageName}-${buildNumber}" override="true"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <and>
                <isset property="branchName"/>
                <not>
                    <equals arg1="${branchName}" arg2="master"/>
                </not>
            </and>
            <then>
                <property name="dockerImageVersion" value="${dockerImageVersion}-${branchName}" override="true"/>
                <if>
                    <isset property="buildNumber"/>
                    <then>
                        <property name="dockerImageVersion" value="${dockerImageVersion}-${buildNumber}" override="true"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <and>
                <isset property="branchName"/>
                <not>
                    <equals arg1="${branchName}" arg2="master"/>
                </not>
            </and>
            <then>
                <exec command="docker tag ${dockerImageName} ${dockerRegistry}/${dockerImageNamespace}${projectName}:${dockerImageVersion}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
                <exec command="docker push ${dockerRegistry}/${dockerImageNamespace}${projectName}:${dockerImageVersion}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
            </then>
            <else>
                <exec command="docker tag ${dockerImageName} ${dockerRegistry}/${dockerImageNamespace}${projectName}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
                <exec command="docker push ${dockerRegistry}/${dockerImageNamespace}${projectName}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>

                <exec command="docker tag ${dockerImageName} ${dockerRegistry}/${dockerImageNamespace}${projectName}:${dockerImageVersion}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
                <exec command="docker push ${dockerRegistry}/${dockerImageNamespace}${projectName}:${dockerImageVersion}" passthru="true" checkreturn="true" level="info" dir="${projectRoot}"/>
            </else>
        </if>
    </target>


</project>