<?xml version="1.0" encoding="UTF-8"?>


<project default="docker:push">


    <property name="docker_push_description" value="push project docker image to a registry" override="true"/>


    <target name="docker:push:init" hidden="true">
        <property name="docker_push_image" value="enabled"/>
        <property name="docker_push_latest" value="disabled"/>
        <property name="docker_push_semver" value="disabled"/>
        <property name="docker_push_cleanup" value="enabled"/>

        <property name="docker_config_push_latest" value="${docker_push_latest}"/>
        <property name="docker_config_push_latest_reason" value=""/>
        <property name="docker_config_push_semver" value="${docker_push_semver}"/>
        <property name="docker_config_push_semver_reason" value=""/>

        <if>
            <and>
                <not>
                    <equals arg1="${branch_name}" arg2=""/>
                </not>
                <not>
                    <equals arg1="${branch_name}" arg2="${branch_name_master}"/>
                </not>
            </and>
            <then>
                <property name="docker_config_push_latest" value="disabled" override="true"/>
                <property name="docker_config_push_latest_reason" value="- branch_name is given or branch_name is not the same as specific branch_name_master" override="true"/>
            </then>
        </if>

        <if>
            <equals arg1="${docker_config_push_latest}" arg2="disabled"/>
            <then>
                <property name="docker_config_push_semver" value="disabled" override="true"/>
                <property name="docker_config_push_semver_reason" value="- push latest not allowed" override="true"/>
            </then>
        </if>
    </target>


    <target name="docker:push:help" depends="docker:push:init, docker:base:help">
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="${docker_push_description}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="property               value"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
        <echo message="docker_push_image      ${docker_push_image}"/>
        <echo message="docker_push_latest     ${docker_push_latest}"/>
        <echo message="docker_push_semver     ${docker_push_semver}"/>
        <echo message="docker_push_cleanup    ${docker_push_cleanup}"/>
        <echo message="----------------------------------------------------------------------------------------------------"/>
    </target>


    <target name="docker:push" depends="clean:dist, docker:push:init, docker:base:init, docker:push:before, docker:push:main, docker:push:after">
        <echo message="successful"/>
    </target>


    <target name="docker:push:before" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:after" hidden="true">
        <echo message="no actions defined"/>
    </target>


    <target name="docker:push:main" hidden="true">
        <if>
            <equals arg1="${docker_config_push_latest}" arg2="enabled"/>
            <then>
                <exec command="docker tag ${docker_config_image} ${docker_config_image_tag_latest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${docker_config_image_tag_latest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <if>
                    <equals arg1="${docker_push_cleanup}" arg2="enabled"/>
                    <then>
                        <exec command="docker rmi ${docker_config_image_tag_latest}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <equals arg1="${docker_config_push_semver}" arg2="enabled"/>
            <then>
                <exec command="docker tag ${docker_config_image} ${docker_config_image_tag_major}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${docker_config_image_tag_major}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <exec command="docker tag ${docker_config_image} ${docker_config_image_tag_minor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${docker_config_image_tag_minor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <exec command="docker tag ${docker_config_image} ${docker_config_image_tag_patch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${docker_config_image_tag_patch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <if>
                    <equals arg1="${docker_push_cleanup}" arg2="enabled"/>
                    <then>
                        <exec command="docker rmi ${docker_config_image_tag_major}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                        <exec command="docker rmi ${docker_config_image_tag_minor}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                        <exec command="docker rmi ${docker_config_image_tag_patch}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                    </then>
                </if>
            </then>
        </if>

        <if>
            <equals arg1="${docker_push_image}" arg2="enabled"/>
            <then>
                <exec command="docker tag ${docker_config_image} ${docker_config_image_tag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                <exec command="docker push ${docker_config_image_tag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>

                <if>
                    <equals arg1="${docker_push_cleanup}" arg2="enabled"/>
                    <then>
                        <exec command="docker rmi ${docker_config_image_tag}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                        <exec command="docker rmi ${docker_config_image}" passthru="true" checkreturn="true" level="info" dir="${project_root}"/>
                    </then>
                </if>
            </then>
        </if>
    </target>


</project>
